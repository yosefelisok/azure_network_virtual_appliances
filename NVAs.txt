
#create a route table.

az network route-table create \
        --name publictable \
        --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
        --disable-bgp-route-propagation false
		
# create a custom route

az network route-table route create \
        --route-table-name publictable \
        --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
        --name productionsubnet \
        --address-prefix 10.0.1.0/24 \
        --next-hop-type VirtualAppliance \
        --next-hop-ip-address 10.0.2.4

#create a vnet
az network vnet create \
        --name vnet \
        --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
        --address-prefixes 10.0.0.0/16 \
        --subnet-name publicsubnet \
        --subnet-prefixes 10.0.0.0/24
		
#create the dmzsubnet subnet
az network vnet subnet create \
        --name privatesubnet \
        --vnet-name vnet \
        --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
        --address-prefixes 10.0.1.0/24
		

#view the list of vnets
az network vnet subnet list \
        --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
        --vnet-name vnet \
        --output table

# associate the route table with the public subnet

az network vnet subnet update \
        --name publicsubnet \
        --vnet-name vnet \
        --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
        --route-table publictable
		

#deploy a Ubuntu

az vm create \
    --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
    --name nva \
    --vnet-name vnet \
    --subnet dmzsubnet \
    --image UbuntuLTS \
    --admin-username azureuser \
    --admin-password Password123!
	
# Enable IP forwarding for the Azure network interface
# get ID of the nva network interface

NICID=$(az vm nic list \
    --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
    --vm-name nva \
    --query "[].{id:id}" --output tsv)

echo $NICID


#get the name of the NVA network interface

NICNAME=$(az vm nic show \
    --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
    --vm-name nva \
    --nic $NICID \
    --query "{name:name}" --output tsv)

echo $NICNAME

#enable IP forwarding for the network interface

az network nic update --name $NICNAME \
    --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
    --ip-forwarding true
	
	
# public IP address of the NVA virtual machine to the variable NVAIP

NVAIP="$(az vm list-ip-addresses \
    --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
    --name nva \
    --query "[].virtualMachine.network.publicIpAddresses[*].ipAddress" \
    --output tsv)"

echo $NVAIP


#Create public and private virtual machines. make a file

#cloud-config
package_upgrade: true
packages:
   - inetutils-traceroute
   
#create a public VM

az vm create \
    --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
    --name public \
    --vnet-name vnet \
    --subnet publicsubnet \
    --image UbuntuLTS \
    --admin-username azureuser \
    --no-wait \
    --custom-data cloud-init.txt \
    --admin-password Password123!


# create a private VM

az vm create \
    --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
    --name private \
    --vnet-name vnet \
    --subnet privatesubnet \
    --image UbuntuLTS \
    --admin-username azureuser \
    --no-wait \
    --custom-data cloud-init.txt \
    --admin-password Password123!
	
	
# watch the running VMs

watch -d -n 5 "az vm list \
    --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
    --show-details \
    --query '[*].{Name:name, ProvisioningState:provisioningState, PowerState:powerState}' \
    --output table"
	
# ave the public IP address of the public VM to a variable named PUBLICIP

PUBLICIP="$(az vm list-ip-addresses \
    --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
    --name public \
    --query "[].virtualMachine.network.publicIpAddresses[*].ipAddress" \
    --output tsv)"

echo $PUBLICIP
	
# save the public IP address of the private VM to a variable named PRIVATEIP

PRIVATEIP="$(az vm list-ip-addresses \
    --resource-group learn-bef1c1d9-fe57-48f8-a8ea-f49ad5878bf8 \
    --name private \
    --query "[].virtualMachine.network.publicIpAddresses[*].ipAddress" \
    --output tsv)"

echo $PRIVATEIP

#trace the route from public to private.

ssh -t -o StrictHostKeyChecking=no azureuser@$PUBLICIP 'traceroute private --type=icmp; exit'

#trace the route from private to public

ssh -t -o StrictHostKeyChecking=no azureuser@$PRIVATEIP 'traceroute public --type=icmp; exit'